// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// --- NextAuth Models ---

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  // User relations
  decks         Deck[]
  cards         Card[]
  studyRecords  StudyRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// --- Application Models ---

/// デッキ（カードのグループ）
model Deck {
  id        String   @id @default(uuid())
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cards     Card[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

/// フラッシュカード
model Card {
  id              String   @id @default(uuid())
  deckId          String
  deck            Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  // Card は Deck に紐づくため、userId は Deck 経由で特定可能だが、
  // クエリの利便性や整合性チェックのために userId を持たせる設計もありうる。
  // 今回は Deck が User に紐づくので Card 自体には userId を持たせず Deck 経由とするか、
  // あるいはアクセス制御の簡易さのために持たせるか。
  // Requirements: "Deck / Card / StudyRecord に userId が追加される" とあるので追加する。
  userId          String
  // User リレーションは必須ではないが、一貫性のために追加してもよい。
  // ただし Deck.userId と不整合が起きないよう注意が必要。
  // ここではシンプルにフィールドのみ追加し、アプリケーションロジックで整合性を担保する、
  // または Deck経由で十分ならリレーションは貼らない。
  // Prisma上でのリレーション定義は必須ではないが、クエリで使うならあったほうがいい。
  // ここでは Deck に紐づいているため、User との直接のリレーションは省略し、フィールドのみ定義する（またはDeck経由でアクセスする）。
  // しかし requirement に従い、検索のしやすさを考慮して User とのリレーションも貼っておくのが無難。
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  frontText       String   @default("")
  backText        String   @default("")
  frontImageId    String?
  backImageId     String?
  /// SRS: 次回復習日 (YYYY-MM-DD)
  nextReviewDate  String
  /// SRS: 現在の復習間隔（日数）
  intervalDays    Int      @default(0)
  /// SRS: 連続正解回数
  repetitionCount Int      @default(0)
  /// SRS: 習熟度ファクター
  easeFactor      Float    @default(2.5)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([deckId])
}

/// 学習記録（1日の学習実績）
model StudyRecord {
  id             String @id @default(uuid())
  userId         String
  user           User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// 日付 (YYYY-MM-DD)
  date           String
  /// その日に復習したカード数（今日の復習）
  reviewedCount  Int    @default(0)
  /// その日の自由学習カード数
  freeStudyCount Int    @default(0)
  /// 今日の復習での評価別カウント
  againCount     Int    @default(0)
  hardCount      Int    @default(0)
  goodCount      Int    @default(0)

  // ユーザーごとに日付はユニークであるべき
  @@unique([userId, date])
}
